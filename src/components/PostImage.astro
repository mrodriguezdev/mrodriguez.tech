---
export interface Props {
  src: string;
  alt: string;
  caption?: string;
  zoom?: boolean;
}

const { src, alt, caption, zoom = true } = Astro.props;
---

<figure class="relative z-0 mx-auto my-8 max-w-full text-center not-prose">
  <img
    src={src}
    alt={alt}
    loading="lazy"
    class:list={{
      "max-w-full h-auto rounded-xl shadow-md transition-transform duration-300 ease-in-out": true,
      "cursor-zoom-in": zoom,
    }}
    data-zoomable={zoom ? "true" : undefined}
  />

  {caption && (
    <figcaption class="mt-2 text-sm italic text-gris-medio">
      {caption}
    </figcaption>
  )}
</figure>

{zoom && (
  <script type="module" is:inline>
    import mediumZoom from "https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.esm.min.js";

    const init = () => {
      const selector = '[data-zoomable="true"]';
      const imgs = document.querySelectorAll(selector);
      if (!imgs.length) return;

      const zoom = mediumZoom(imgs, {
        background: "rgba(0, 0, 0, 0.85)",
        margin: 24,
        scrollOffset: 0,
      });

      imgs.forEach((img) => {
        if (!img.complete) {
          img.addEventListener("load", () => zoom.refresh());
        }
      });
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }

    document.addEventListener("astro:page-load", init);
    document.addEventListener("astro:after-swap", init);
  </script>
)}

<style>
  .medium-zoom-overlay {
    z-index: 9999 !important;
  }

  .medium-zoom-image--opened {
    z-index: 10000 !important;
    transition: transform 0.25s ease, opacity 0.25s ease;
  }
</style>
