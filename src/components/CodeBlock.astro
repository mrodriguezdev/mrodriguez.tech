---
export type Props = {
  code: string;
};

const { code } = Astro.props;
---

<div class="code-toolbar relative my-4 not-prose">
  <pre
    class="bg-gris-oscuro text-blanco-puro px-4 py-2 rounded-md overflow-auto whitespace-pre"
  >
    <code class="whitespace-pre tex-base">{code}</code>
  </pre>

  <div class="absolute top-0 right-0">
    <div class="inline-block m-2">
      <button
        type="button"
        class="bg-verde-lima text-blanco-puro px-3 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition"
      >
        Copiar
      </button>
    </div>
  </div>
</div>

<script is:inline>
  const initCopyButtons = () => {
    const toolbars = document.querySelectorAll(".code-toolbar");

    toolbars.forEach((toolbar) => {
      const button = toolbar.querySelector("button");
      const codeEl = toolbar.querySelector("code");

      if (!button || !codeEl) return;

      if (button.dataset.bound === "true") return;
      button.dataset.bound = "true";

      button.addEventListener("click", async () => {
        const text = codeEl.textContent ?? "";
        if (!text.trim()) return;

        try {
          await navigator.clipboard.writeText(text);
          const original = button.textContent;
          button.textContent = "Copiado!";
          setTimeout(() => (button.textContent = original), 2000);
        } catch (err) {
          console.error("Fallo al copiar el c√≥digo: ", err);
        }
      });
    });
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initCopyButtons);
  } else {
    initCopyButtons();
  }

  document.addEventListener("astro:page-load", initCopyButtons);
  document.addEventListener("astro:after-swap", initCopyButtons);
</script>
